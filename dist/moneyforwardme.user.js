// ==UserScript==
// @name マネーフォワードME Web
// @description Make a few changes to the design of MoneyforwardME
// @version 0.1.5
// @author A.A
// @homepage https://github.com/aozou99/TampermonkeyScripts#readme
// @supportURL https://github.com/aozou99/TempermonkeyScripts
// @match https://moneyforward.com/bs/portfolio
// @match https://moneyforward.com/bs/history
// @downloadURL https://github.com/aozou99/TempermonkeyScripts/raw/main/dist/moneyforwardme.user.js
// @grant none
// @iconURL https://assets.moneyforward.com/assets/favicon-710b014dd04a85070bb0a55fa894b599015b5310333d38da9c85ad03594bbc20.ico
// @namespace https://github.com/aozou99/TempermonkeyScripts
// @updateURL https://github.com/aozou99/TempermonkeyScripts/raw/main/dist/moneyforwardme.user.js
// ==/UserScript==

(()=>{"use strict";var e,t,n,o={887:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.hookFetch=t.hookXHR=void 0,t.hookXHR=function(e){var t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(n,o,r,a,i){return this.addEventListener("readystatechange",(function(){4===this.readyState&&e({method:n,url:o,status:this.status,responseText:this.responseText})})),t.apply(this,[n,o,!!r,a,i])}},t.hookFetch=function(e){var t=window.fetch;window.fetch=function(){for(var n,o,r=[],a=0;a<arguments.length;a++)r[a]=arguments[a];if("string"==typeof r[0])n=r[0],o=r[1]&&r[1].method||"GET";else{if(!(r[0]instanceof Request))throw new Error("Invalid request info");n=r[0].url,o=r[0].method}var i=t.apply(this,r);return i.then((function(t){t.clone().text().then((function(r){e({method:o,url:n,status:t.status,responseText:r})}))})).catch((function(e){console.log("Fetch error:",e)})),i}}},639:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,a){function i(e){try{l(o.next(e))}catch(e){a(e)}}function c(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}l((o=o.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var n,o,r,a,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(l){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,l])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleHistoryPage=void 0;var a=n(887);function i(){return o(this,void 0,void 0,(function(){var e,t,n,o,a,i;return r(this,(function(r){switch(r.label){case 0:return[4,d(10)];case 1:return r.sent(),l=document.querySelectorAll(".highcharts-legend-item:not(.highcharts-legend-item-hidden) tspan"),e=Array.from(l).map((function(e){return e.textContent||""})),t=window.timeSeriesData,n=c(e,t),o=n.percentageChange,a=n.totalStart,i=n.totalEnd,function(e,t,n,o){var r,a=document.querySelector("#graph_contents"),i=document.querySelector("#container_time_series_trend");if(a&&i){var c=function(e,t,n,o){var r,a,i,c=document.createElement("div");c.id="us_total-price-html",(r=c.classList).add.apply(r,["mt-16","pull-right","text-align-right"]);var l=document.createElement("p");(a=l.classList).add.apply(a,["mb-2"]);var d=document.createElement("span");d.textContent="総資産";var u=document.createElement("span");(i=u.classList).add.apply(i,["total-price"]),u.textContent="¥".concat(e.toLocaleString()),l.appendChild(d),l.appendChild(u);var s=function(e,t,n,o){var r,a,i=o.startsWith("-"),c=document.createElement("span");(r=c.classList).add.apply(r,[i?"is-red-ink":"is-blue-ink"]);var l=document.createTextNode("".concat(t,"：¥").concat(n.toLocaleString(),"( ").concat(o," )"));c.appendChild(l);var d=document.createElement("i");return(a=d.classList).add.apply(a,[i?"mf-icon-down":"mf-icon-up","ml-8"]),c.appendChild(d),c}(0,function(e){return"前日"==e?e:"".concat(e,"前比")}(t),n,o);return c.appendChild(l),c.appendChild(s),c}(t,e,n,o),l=document.querySelector("#us_total-price-html");l&&(null===(r=l.parentNode)||void 0===r||r.removeChild(l)),a.insertBefore(c,i)}}(function(){var e,t;return(null===(t=null===(e=document.querySelector(".btn.range-radio.active"))||void 0===e?void 0:e.textContent)||void 0===t?void 0:t.replaceAll("\n",""))||""}(),i,i-a,o),[2]}var l}))}))}function c(e,t){var n=t.reduce((function(t,n){return e.includes(n.name)&&(t.start+=n.data[0],t.end+=n.data.at(-1)||0),t}),{start:0,end:0});return{percentageChange:l(n.start,n.end),totalStart:n.start,totalEnd:n.end}}function l(e,t){var n=(t-e)/e*100;return"".concat(isNaN(n)?0:n.toFixed(2),"%")}function d(e){return new Promise((function(t){return setTimeout(t,e)}))}t.handleHistoryPage=function(){var e,t;(e=document.createElement("style")).textContent="\n    .is-red-ink {\n        color: #d04e4e;\n        font-weight: 500;\n    }\n    .is-blue-ink {\n        color: #52aaca;\n        font-weight: 500;\n    }\n    .ml-8 {\n        margin-left: 8px;\n    }\n    .mt-16 {\n        margin-top: 16px;\n    }\n    .mb-2 {\n        margin-bottom: 2px;\n    }\n    .total-price {\n        font-size: 24px;\n        margin-left: 8px;\n    }\n    .text-align-right {\n        text-align: right;\n    }\n    ",document.head.appendChild(e),t=function(e){e.url.includes("https://moneyforward.com/update_chart/")&&(function(){o(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,d(300)];case 1:return e.sent(),document.querySelectorAll(".highcharts-legend-item").forEach((function(e){e.addEventListener("click",i)})),[2]}}))}))}(),i())},(0,a.hookXHR)(t),(0,a.hookFetch)(t),function(){o(this,void 0,void 0,(function(){var e;return r(this,(function(t){return(e=document.querySelector('[href="/update_chart/30"]'))&&e.click(),[2]}))}))}()}},311:(e,t)=>{function n(e,t){for(var n=e.getElementsByTagName("tr"),o=0,r=1;r<n.length;r++){var a=n[r].getElementsByTagName("td")[t];if(a){var i=(a.textContent||a.innerText).replace(/,/g,"").replace("円","").trim(),c=parseFloat(i);isNaN(c)||(o+=c)}}return o}Object.defineProperty(t,"__esModule",{value:!0}),t.handlePortfolioPage=void 0,t.handlePortfolioPage=function(){var e;!function(e){var t,n,o,r,a=document.querySelector(".mf-col-custom-ad");a&&a.remove();var i=e.reduce((function(e,t){return Object.keys(t).forEach((function(n){if(!["評価損益率","Section名"].includes(n)){var o=n;o in e||(e[o]=0),e[o]+=t[o]}})),e}),{}),c=document.querySelector("section.bs-total-assets > div.heading-radius-box");if(c){c.classList.remove("mf-mb20"),c.classList.add("mf-mb0");var l=["有価証券： ".concat(i.評価額の合計.toLocaleString(),"円"),"評価損益： ".concat(i.評価損益の合計.toLocaleString(),"円")],d=c;l.forEach((function(e){var t,n=d.cloneNode();n.textContent=e,null===(t=d.parentNode)||void 0===t||t.insertBefore(n,d.nextSibling),d=n}))}var u=document.querySelector("section.bs-total-assets > h1.heading-small");if(u){var s=u.cloneNode();s.textContent="評価損益の内訳",s.style.borderLeftColor="green",null===(t=u.parentNode)||void 0===t||t.appendChild(s);var f=document.createElement("table");f.classList.add("table","table-bordered"),[{タイトル:"投資信託",リンク先:"portfolio_det_mf",評価損益:(null===(n=e.find((function(e){return"投資信託"===e.Section名})))||void 0===n?void 0:n.評価損益の合計)||0},{タイトル:"年金",リンク先:"portfolio_det_pns",評価損益:(null===(o=e.find((function(e){return"年金"===e.Section名})))||void 0===o?void 0:o.評価損益の合計)||0}].forEach((function(e){var t=document.createElement("tr"),n=document.createElement("th"),o=document.createElement("img");o.src="https://assets.moneyforward.com/assets/bs/icon_table_arrow-528280ce2bfa721a3a1ee5b7c9bfc6e14aee0a27737c4a3bf34d854cbae2091f.png";var r=document.createElement("a");r.href="portfolio#".concat(e.リンク先),r.textContent=e.タイトル,n.append(o),n.append(r),t.append(n);var a=document.createElement("td");a.textContent="".concat(e.評価損益.toLocaleString(),"円"),t.append(a);var c=document.createElement("td");c.textContent="".concat((e.評価損益/i.評価損益の合計*100).toFixed(2),"%"),t.append(c),f.appendChild(t)})),null===(r=null==c?void 0:c.parentNode)||void 0===r||r.appendChild(f)}}((e=[],[{id:"portfolio_det_mf",対象名:"投資信託",評価損益カラムIndex:6,評価額カラムIndex:4},{id:"portfolio_det_pns",対象名:"年金",評価損益カラムIndex:3,評価額カラムIndex:2}].forEach((function(t){var o=function(e){var t=document.querySelector("#".concat(e.id," > table")),o=n(t,e.評価損益カラムIndex),r=n(t,e.評価額カラムIndex),a=o/(r-o),i=r-o;return{Section名:e.対象名,評価損益の合計:o,評価額の合計:r,評価損益率:a,元本額の合計:i}}(t);!function(e,t,n){var o=document.querySelector("#".concat(e.id," > section > h1.heading-small"));o&&(o.textContent+="(評価損益： ".concat(t.toLocaleString(),"円、 評価損益率： ").concat((100*n).toFixed(2),"%)"))}(t,o.評価損益の合計,o.評価損益率),e.push(o)})),e))}}},r={};function a(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={exports:{}};return o[e].call(n.exports,n,n.exports,a),n.exports}t=a(311),n=a(639),(e=window.location.href).includes("/bs/portfolio")?(0,t.handlePortfolioPage)():e.includes("/bs/history")&&(0,n.handleHistoryPage)()})();